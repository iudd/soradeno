# 飞书多维表格集成方案

## 📊 多维表格设计

### 表格结构

| 字段名 | 字段类型 | 说明 | 必填 |
|--------|---------|------|------|
| 任务ID | 自动编号 | 自动生成的唯一ID | ✅ |
| 提示词 | 多行文本 | 视频/图片生成的提示词 | ✅ |
| 角色 | 单选 | 视频/图片角色（可选） | ❌ |
| 模型 | 单选 | 视频/图片模型 | ✅ |
| 生成类型 | 单选 | 视频生成/图片生成 | ✅ |
| Sora图片 | 附件 | 用于视频生成的参考图片（可选） | ❌ |
| 是否已生成 | 复选框 | 标记是否已生成 | ✅ |
| 生成状态 | 单选 | 待生成/生成中/成功/失败 | ✅ |
| 生成时间 | 日期时间 | 视频/图片生成完成时间 | ❌ |
| 视频URL | URL | 生成的视频链接 | ❌ |
| 图片URL | URL | 生成的图片链接 | ❌ |
| 错误信息 | 多行文本 | 生成失败时的错误信息 | ❌ |
| 创建时间 | 创建时间 | 记录创建时间 | ✅ |
| 更新时间 | 最后编辑时间 | 记录更新时间 | ✅ |

### 字段详细说明

#### 1. 提示词（多行文本）
- 描述要生成的视频/图片内容
- 示例：`一只小猫在草地上奔跑`

#### 2. 角色（单选）
- 选项：
  - 无角色
  - 角色1
  - 角色2
  - 角色3
  - ...（根据实际需求添加）

#### 3. 模型（单选）
- 选项：
  - 视频：
    - `sora-video-10s` - 默认 10秒
    - `sora-video-15s` - 默认 15秒
    - `sora-video-landscape-10s` - 横屏 10秒
    - `sora-video-landscape-15s` - 横屏 15秒
    - `sora-video-portrait-10s` - 竖屏 10秒
    - `sora-video-portrait-15s` - 竖屏 15秒
  - 图片：
    - `dall-e-3` - DALL-E 3 图片生成
    - `midjourney-v6` - Midjourney v6
    - `stable-diffusion-xl` - Stable Diffusion XL

#### 4. 生成类型（单选）
- 选项：
  - 视频生成
  - 图片生成

#### 5. Sora图片（附件）
- 用于视频生成的参考图片（可选）
- 上传图片后，Sora将基于该图片生成视频
- 支持.jpg、.png等常见图片格式
- 建议上传清晰、主体明确的图片
- 文件大小限制：建议不超过10MB

#### 6. 生成状态（单选）
- 选项：
  - 🟡 待生成
  - 🔵 生成中
  - 🟢 成功
  - 🔴 失败

## 🔑 飞书 API 配置

### 1. 创建飞书应用

1. 访问 [飞书开放平台](https://open.feishu.cn/)
2. 创建企业自建应用
3. 获取 `App ID` 和 `App Secret`

### 2. 配置权限

需要开通以下权限：
- `bitable:app` - 查看、编辑多维表格
- `bitable:app:readonly` - 查看多维表格

### 3. 获取表格信息

- **App Token**: 多维表格的唯一标识
- **Table ID**: 数据表的唯一标识

获取方式：
1. 打开多维表格
2. 查看 URL：`https://xxx.feishu.cn/base/[app_token]?table=[table_id]`

## 🔧 环境变量配置

在 Deno Deploy 或 `.env` 文件中添加：

```env
# 飞书应用配置
FEISHU_APP_ID=cli_xxxxxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxxxxxxxxxxxxx

# 多维表格配置
FEISHU_APP_TOKEN=bascnxxxxxxxxxxxxxx
FEISHU_TABLE_ID=tblxxxxxxxxxxxxxx
```

## 📡 API 端点设计

### 1. 获取待生成任务列表
```
GET /api/feishu/tasks?status=pending
```

响应：
```json
{
  "tasks": [
    {
      "record_id": "recxxxxxx",
      "prompt": "一只小猫在草地上奔跑",
      "character": "角色1",
      "model": "sora-video-landscape-10s",
      "generation_type": "视频生成",
      "sora_image": null,
      "status": "待生成"
    },
    {
      "record_id": "recxxxxxy",
      "prompt": "夕阳下的山峰",
      "character": "无角色",
      "model": "sora-video-landscape-15s",
      "generation_type": "视频生成",
      "sora_image": "https://xxx.feishu.cn/space/api/file/...",
      "status": "待生成"
    },
    {
      "record_id": "recxxxxxz",
      "prompt": "抽象艺术画作",
      "character": "角色2",
      "model": "midjourney-v6",
      "generation_type": "图片生成",
      "sora_image": null,
      "status": "待生成"
    }
  ]
}
```

### 2. 更新任务状态
```
POST /api/feishu/tasks/{record_id}/status
```

请求：
```json
{
  "status": "生成中",
  "video_url": "https://...",
  "image_url": "https://...",
  "error": "错误信息"
}
```

### 3. 批量生成视频
```
POST /api/feishu/generate/batch
```

请求：
```json
{
  "limit": 10,  // 最多生成数量
  "auto": true  // 是否自动模式
}
```

### 4. 手动生成单个视频
```
POST /api/feishu/generate/single
```

请求：
```json
{
  "record_id": "recxxxxxx"
}
```

## 🎯 功能实现

### 1. 自动批量生成
- 定时任务（可选）
- 从表格获取所有"待生成"状态的记录
- 逐个生成视频
- 更新生成状态和结果

### 2. 手动生成单条
- 选择特定记录
- 立即生成视频
- 实时更新状态

### 3. 状态同步
- 生成前：更新为"生成中"
- 生成成功：更新为"成功"，填写视频URL和生成时间
- 生成失败：更新为"失败"，填写错误信息

## 🖼️ Sora图片字段使用指南

### 什么是Sora图片字段？
Sora图片字段允许用户上传参考图片，Sora将基于这些图片生成视频。这个功能特别适合以下场景：
- 基于现有图片风格生成视频
- 将静态图片转换为动态视频
- 使用特定场景或角色生成视频内容

### 如何使用Sora图片字段？

#### 1. 上传图片
1. 在飞书表格中新建记录或编辑现有记录
2. 找到"Sora图片"字段
3. 点击上传按钮，选择图片文件
4. 支持的格式：.jpg、.png、.webp等常见图片格式
5. 建议文件大小不超过10MB

#### 2. 设置其他参数
- **提示词**：描述您想要的视频效果，可以基于上传的图片提出具体要求
- **生成类型**：选择"视频生成"
- **模型**：选择适合的视频生成模型

#### 3. 生成视频
- 系统会检测到您上传了参考图片
- 生成时会结合提示词和参考图片
- 生成的视频将保持参考图片的主要特征

### 最佳实践

1. **图片选择**
   - 选择清晰、主体明确的图片
   - 避免过于复杂或包含多个主要对象的图片
   - 确保图片内容符合提示词描述

2. **提示词编写**
   - 简洁描述您想要的效果
   - 提及参考图片中的关键元素
   - 描述动态变化（如："风吹过树叶"、"水波荡漾"）

3. **模型选择**
   - 对于有参考图片的视频生成，推荐使用标准模型
   - 特殊效果可尝试其他模型选项

### 技术说明

1. **图片处理**
   - 系统会自动提取图片的主要特征
   - 忽略背景和次要元素
   - 提取的参考信息与提示词结合

2. **生成过程**
   - 有参考图片的视频生成时间可能稍长
   - 系统会优先处理提示词与图片的结合点
   - 最终视频效果是提示词和图片共同作用的结果

## 🔄 工作流程

```
1. 用户在飞书表格中添加任务
   ↓
2. 设置提示词、角色、模型
   ↓
3. (可选)上传Sora参考图片
   ↓
4. 状态默认为"待生成"
   ↓
5. 系统获取待生成任务
   ↓
6. 调用 Sora API 生成视频
   ↓
7. 更新状态为"生成中"
   ↓
8. 生成完成后更新：
   - 状态 → "成功"
   - 视频URL
   - 生成时间
   ↓
9. 用户在表格中查看结果
```

## 📝 使用示例

### 在飞书表格中添加任务

| 提示词 | 角色 | 模型 | 生成类型 | Sora图片 | 生成状态 |
|--------|------|------|----------|----------|---------|
| 一只小猫在草地上奔跑 | 无角色 | sora-video-landscape-10s | 视频生成 | - | 🟡 待生成 |
| 日落时分的海滩 | 角色1 | sora-video-landscape-15s | 视频生成 | [图片] | 🟡 待生成 |
| 城市夜景延时摄影 | 无角色 | sora-video-portrait-10s | 视频生成 | - | 🟡 待生成 |
| 夕阳下的山峰 | 无角色 | dall-e-3 | 图片生成 | - | 🟡 待生成 |
| 抽象艺术画作 | 角色2 | midjourney-v6 | 图片生成 | - | 🟡 待生成 |

### 生成完成后

| 提示词 | 角色 | 模型 | 生成类型 | Sora图片 | 生成状态 | 生成时间 | 视频URL | 图片URL |
|--------|------|------|----------|----------|---------|---------|---------|---------|
| 一只小猫在草地上奔跑 | 无角色 | sora-video-landscape-10s | 视频生成 | - | 🟢 成功 | 2025-12-22 23:00 | [查看视频](https://...) | - |
| 日落时分的海滩 | 角色1 | sora-video-landscape-15s | 视频生成 | [图片] | 🟢 成功 | 2025-12-22 23:05 | [查看视频](https://...) | - |
| 城市夜景延时摄影 | 无角色 | sora-video-portrait-10s | 视频生成 | - | 🔴 失败 | 2025-12-22 23:10 | - | - |
| 夕阳下的山峰 | 无角色 | dall-e-3 | 图片生成 | - | 🟢 成功 | 2025-12-22 23:15 | - | [查看图片](https://...) |
| 抽象艺术画作 | 角色2 | midjourney-v6 | 图片生成 | - | 🟢 成功 | 2025-12-22 23:20 | - | [查看图片](https://...) |

## 🛡️ 错误处理

### 常见错误

1. **认证失败**
   - 检查 App ID 和 App Secret
   - 确认应用权限

2. **表格访问失败**
   - 检查 App Token 和 Table ID
   - 确认应用已添加到表格

3. **生成失败**
   - 记录错误信息到表格
   - 状态更新为"失败"
   - 可重新生成

## 🔐 安全建议

1. **不要在前端暴露**
   - App Secret 必须在后端使用
   - 使用环境变量存储敏感信息

2. **访问控制**
   - 限制 API 访问频率
   - 添加身份验证

3. **数据验证**
   - 验证提示词长度
   - 检查模型是否有效

## 📚 相关文档

- [飞书开放平台文档](https://open.feishu.cn/document/home/index)
- [多维表格 API](https://open.feishu.cn/document/server-docs/docs/bitable-v1/app-table-record/list)
- [飞书认证指南](https://open.feishu.cn/document/server-docs/authentication-management/access-token/tenant_access_token_internal)
