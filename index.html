<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoraDeno - Sora2mb API ä»£ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-online { background-color: #22c55e; }
        .status-offline { background-color: #ef4444; }
        .status-checking { background-color: #f59e0b; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                SoraDeno
            </h1>
            <p class="text-gray-400">Sora2mb API ä»£ç†æœåŠ¡</p>
        </header>

        <!-- API Status Section -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">ğŸ”Œ API çŠ¶æ€</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Backend API Status -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <h3 class="font-medium mb-3">åç«¯ API (Sora2mb)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">åœ°å€:</span>
                            <a href="https://iyougame-soarmb.hf.space" target="_blank" class="text-blue-400 hover:underline truncate ml-2">
                                iyougame-soarmb.hf.space
                            </a>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">çŠ¶æ€:</span>
                            <span id="backendStatus" class="flex items-center">
                                <span class="status-dot status-checking"></span>
                                <span>æ£€æµ‹ä¸­...</span>
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">å“åº”æ—¶é—´:</span>
                            <span id="backendLatency">-</span>
                        </div>
                    </div>
                </div>

                <!-- Local Proxy Status -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <h3 class="font-medium mb-3">æœ¬åœ°ä»£ç† (SoraDeno)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">åœ°å€:</span>
                            <span id="proxyUrl" class="text-blue-400 truncate ml-2"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">çŠ¶æ€:</span>
                            <span id="proxyStatus" class="flex items-center">
                                <span class="status-dot status-checking"></span>
                                <span>æ£€æµ‹ä¸­...</span>
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">æ£€æµ‹æ—¶é—´:</span>
                            <span id="checkTime">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <button id="refreshStatus" onclick="checkAllStatus()" class="mt-4 bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-sm transition-colors">
                ğŸ”„ åˆ·æ–°çŠ¶æ€
            </button>
        </div>

        <!-- Available Models Section -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">ğŸ¨ å¯ç”¨æ¨¡å‹</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Image Models -->
                <div>
                    <h3 class="font-medium mb-3 text-green-400">ğŸ–¼ï¸ å›¾ç‰‡æ¨¡å‹</h3>
                    <div id="imageModels" class="space-y-2">
                        <div class="text-gray-400 text-sm">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                <!-- Video Models -->
                <div>
                    <h3 class="font-medium mb-3 text-purple-400">ğŸ¬ è§†é¢‘æ¨¡å‹</h3>
                    <div id="videoModels" class="space-y-2">
                        <div class="text-gray-400 text-sm">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generation Form -->
        <div class="grid md:grid-cols-2 gap-8">
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ¬ ç”Ÿæˆå†…å®¹</h2>
                <form id="generateForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">æ¨¡å‹</label>
                        <select id="model" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">æç¤ºè¯ (Prompt)</label>
                        <textarea
                            id="prompt"
                            rows="4"
                            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„å†…å®¹..."
                            required
                        ></textarea>
                    </div>

                    <button
                        type="submit"
                        id="generateBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed px-4 py-2 rounded-md font-medium transition-colors flex items-center justify-center gap-2"
                    >
                        <span>ğŸš€ å¼€å§‹ç”Ÿæˆ</span>
                    </button>
                </form>
            </div>

            <!-- Results -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ“º ç”Ÿæˆç»“æœ</h2>
                <div id="results" class="space-y-4">
                    <div class="text-gray-400 text-center py-8">
                        æš‚æ— ç”Ÿæˆç»“æœ
                    </div>
                </div>
            </div>
        </div>

        <!-- API Usage Example -->
        <div class="mt-8 bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“– API ä½¿ç”¨ç¤ºä¾‹</h2>
            <div class="bg-gray-900 rounded p-4 overflow-x-auto">
                <pre id="apiExample" class="text-sm text-green-400"><code>curl -X POST "<span id="exampleUrl"></span>/v1/chat/completions" \
  -H "Authorization: Bearer han1234" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "sora-video-landscape-10s",
    "messages": [{"role": "user", "content": "ä¸€åªå°çŒ«åœ¨è‰åœ°ä¸Šå¥”è·‘"}],
    "stream": true
  }'</code></pre>
            </div>
            <button onclick="copyApiExample()" class="mt-3 bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-sm transition-colors">
                ğŸ“‹ å¤åˆ¶ç¤ºä¾‹
            </button>
        </div>

        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>Powered by <a href="https://github.com/iudd/Sora2mb" target="_blank" class="text-blue-400 hover:underline">Sora2mb</a> | 
            <a href="https://github.com/iudd/soradeno" target="_blank" class="text-blue-400 hover:underline">SoraDeno</a></p>
        </footer>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const BACKEND_API = 'https://iyougame-soarmb.hf.space';

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('proxyUrl').textContent = API_BASE;
            document.getElementById('exampleUrl').textContent = API_BASE;
            checkAllStatus();
            loadModels();
        });

        // Check all API status
        async function checkAllStatus() {
            checkBackendStatus();
            checkProxyStatus();
        }

        // Check backend API status
        async function checkBackendStatus() {
            const statusEl = document.getElementById('backendStatus');
            const latencyEl = document.getElementById('backendLatency');
            
            statusEl.innerHTML = '<span class="status-dot status-checking"></span><span>æ£€æµ‹ä¸­...</span>';
            
            const startTime = Date.now();
            try {
                const response = await fetch(`${BACKEND_API}/`, {
                    method: 'GET',
                    mode: 'no-cors' // HF Spaces may have CORS issues
                });
                const latency = Date.now() - startTime;
                
                // no-cors mode always returns opaque response, so we assume success if no error
                statusEl.innerHTML = '<span class="status-dot status-online"></span><span class="text-green-400">åœ¨çº¿</span>';
                latencyEl.textContent = `${latency}ms`;
            } catch (error) {
                statusEl.innerHTML = '<span class="status-dot status-offline"></span><span class="text-red-400">ç¦»çº¿</span>';
                latencyEl.textContent = '-';
            }
        }

        // Check local proxy status
        async function checkProxyStatus() {
            const statusEl = document.getElementById('proxyStatus');
            const timeEl = document.getElementById('checkTime');
            
            statusEl.innerHTML = '<span class="status-dot status-checking"></span><span>æ£€æµ‹ä¸­...</span>';
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (response.ok && data.status === 'ok') {
                    statusEl.innerHTML = '<span class="status-dot status-online"></span><span class="text-green-400">åœ¨çº¿</span>';
                } else {
                    statusEl.innerHTML = '<span class="status-dot status-offline"></span><span class="text-red-400">å¼‚å¸¸</span>';
                }
                timeEl.textContent = new Date().toLocaleTimeString();
            } catch (error) {
                statusEl.innerHTML = '<span class="status-dot status-offline"></span><span class="text-red-400">ç¦»çº¿</span>';
                timeEl.textContent = new Date().toLocaleTimeString();
            }
        }

        // Load available models
        async function loadModels() {
            const imageModelsEl = document.getElementById('imageModels');
            const videoModelsEl = document.getElementById('videoModels');
            const modelSelect = document.getElementById('model');

            // Define models based on Sora2mb documentation
            const models = {
                image: [
                    { id: 'sora-image', name: 'é»˜è®¤', size: '360Ã—360' },
                    { id: 'sora-image-landscape', name: 'æ¨ªå±', size: '540Ã—360' },
                    { id: 'sora-image-portrait', name: 'ç«–å±', size: '360Ã—540' },
                ],
                video: [
                    { id: 'sora-video-10s', name: '10ç§’', duration: '10s' },
                    { id: 'sora-video-15s', name: '15ç§’', duration: '15s' },
                    { id: 'sora-video-landscape-10s', name: 'æ¨ªå± 10ç§’', duration: '10s' },
                    { id: 'sora-video-landscape-15s', name: 'æ¨ªå± 15ç§’', duration: '15s' },
                    { id: 'sora-video-portrait-10s', name: 'ç«–å± 10ç§’', duration: '10s' },
                    { id: 'sora-video-portrait-15s', name: 'ç«–å± 15ç§’', duration: '15s' },
                ],
            };

            // Render image models
            imageModelsEl.innerHTML = models.image.map(m => `
                <div class="bg-gray-600 rounded px-3 py-2 text-sm flex justify-between">
                    <span class="font-mono">${m.id}</span>
                    <span class="text-gray-400">${m.size}</span>
                </div>
            `).join('');

            // Render video models
            videoModelsEl.innerHTML = models.video.map(m => `
                <div class="bg-gray-600 rounded px-3 py-2 text-sm flex justify-between">
                    <span class="font-mono">${m.id}</span>
                    <span class="text-gray-400">${m.duration}</span>
                </div>
            `).join('');

            // Populate model select
            modelSelect.innerHTML = `
                <optgroup label="ğŸ–¼ï¸ å›¾ç‰‡æ¨¡å‹">
                    ${models.image.map(m => `<option value="${m.id}">${m.id} (${m.size})</option>`).join('')}
                </optgroup>
                <optgroup label="ğŸ¬ è§†é¢‘æ¨¡å‹">
                    ${models.video.map(m => `<option value="${m.id}">${m.id} (${m.duration})</option>`).join('')}
                </optgroup>
            `;
            modelSelect.value = 'sora-video-landscape-10s';
        }

        // Handle form submission
        document.getElementById('generateForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const model = document.getElementById('model').value;
            const prompt = document.getElementById('prompt').value;
            const generateBtn = document.getElementById('generateBtn');
            const resultsDiv = document.getElementById('results');

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<div class="loading-spinner"></div><span>ç”Ÿæˆä¸­...</span>';
            resultsDiv.innerHTML = '<div class="text-yellow-400">â³ æ­£åœ¨ç”Ÿæˆï¼Œè¯·ç¨å€™...</div>';

            try {
                const response = await fetch(`${API_BASE}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer han1234',
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: prompt }],
                        stream: true,
                    }),
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices?.[0]?.delta?.content || '';
                                fullContent += content;
                                resultsDiv.innerHTML = `<div class="text-green-400 whitespace-pre-wrap">${fullContent}</div>`;
                            } catch (e) {
                                // Skip invalid JSON
                            }
                        }
                    }
                }

                if (!fullContent) {
                    resultsDiv.innerHTML = '<div class="text-yellow-400">ç”Ÿæˆå®Œæˆï¼Œä½†æ²¡æœ‰è¿”å›å†…å®¹</div>';
                }

            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = `<div class="text-red-400">âŒ ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>ğŸš€ å¼€å§‹ç”Ÿæˆ</span>';
            }
        });

        // Copy API example
        function copyApiExample() {
            const example = document.getElementById('apiExample').textContent;
            navigator.clipboard.writeText(example).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²å¤åˆ¶!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 1500);
            });
        }
    </script>
</body>
</html>
